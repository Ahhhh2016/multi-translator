<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi Translator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="icon" type="image/png" href="favicon_square.png">
    <style>
        /* åŸºç¡€è®¾ç½® */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #F8FAFC; /* Slate-50: æ¯”åŸæœ¬çš„ Zinc æ›´æ¸…é€ */
            color: #334155; /* Slate-700: å­—ä½“é¢œè‰²æ›´æŸ”å’Œï¼Œä¸æ˜¯çº¯é»‘ */
            -webkit-font-smoothing: antialiased;
            /* é€‰ä¸­æ–‡æœ¬é¢œè‰² */
            ::selection {
                background-color: #E2E8F0;
                color: #0F172A;
            }
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– - æ›´ç»†æ›´æ·¡ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 3px;
            transition: background 0.2s;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94A3B8;
        }

        /* ç¿»è¯‘å¡ç‰‡æ ·å¼ - æ‚¬æµ®è´¨æ„Ÿä¼˜åŒ– */
        .translation-window {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background-color: #FFFFFF;
            /* æç»†çš„è¾¹æ¡† + æŸ”å’Œçš„æ‰©æ•£é˜´å½± */
            border: 1px solid rgba(226, 232, 240, 0.8); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }
        .translation-window:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.01);
            border-color: rgba(203, 213, 225, 0.6);
        }

        /* è¾“å…¥æ¡†æ ·å¼ä¼˜åŒ– */
        .input-box {
            border: none;
            transition: all 0.2s ease;
            background-color: transparent;
            color: #1E293B; /* Slate-800 */
            font-size: 0.95rem;
            line-height: 1.7; /* å¢åŠ è¡Œé«˜ï¼Œé˜…è¯»æ›´èˆ’é€‚ */
        }
        .input-box:focus {
            outline: none;
            /* èšç„¦æ—¶ä¸æ”¹å˜èƒŒæ™¯ï¼Œä¿æŒæ¸…çˆ½ */
        }
        
        /* æŒ‰é’®é€šç”¨åŠ¨æ•ˆ */
        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn:active {
            transform: scale(0.97);
        }

        /* åŠ¨ç”»ç±» */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .fade-out { animation: fadeOut 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: scale(0.98); } }

        /* è¯­è¨€é€‰æ‹©å™¨ - æ›´åŠ æ‰å¹³åŒ– */
        .language-selector {
            transition: all 0.2s;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-right: 2.5rem;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        .language-selector:hover {
            background-color: #F1F5F9;
        }
        .language-selector:focus {
            outline: none;
            border-color: #94A3B8;
            box-shadow: 0 0 0 3px rgba(226, 232, 240, 0.5); /* æŸ”å’Œçš„å…‰æ™• */
        }
        #ui-lang-select.language-selector {
            background-size: 1.1em 1.1em;
            background-position: right 0.6rem center;
            padding-right: 2.25rem;
            min-width: 6.5rem;
            white-space: nowrap;
        }

        .logo { font-weight: 700; letter-spacing: -0.025em; }

        /* Resize handle ä¼˜åŒ– */
        .resize-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            right: 2px;
            bottom: 2px;
            cursor: nwse-resize;
            opacity: 0.2;
            transition: opacity 0.2s;
            border-radius: 0 0 12px 0;
        }
        .resize-handle:hover { opacity: 0.6; }
        .resize-handle::before {
            content: '';
            position: absolute;
            right: 5px;
            bottom: 5px;
            width: 6px;
            height: 6px;
            border-right: 2px solid #64748B;
            border-bottom: 2px solid #64748B;
            border-radius: 1px;
        }
        
        .translation-window.resizing { user-select: none; }

        /* æ‹–æ‹½ç›¸å…³ */
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        .translation-window.dragging {
            opacity: 0.95;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            transform: scale(1.01) rotate(0.5deg);
            user-select: none;
            pointer-events: none;
            z-index: 50;
            border-color: #94A3B8;
        }
        .drop-placeholder {
            background-color: #F1F5F9; /* Slate-100 */
            border: 2px dashed #CBD5E1; /* Slate-300 */
            border-radius: 16px;
            margin-bottom: 1.5rem;
        }

        /* æ¨¡æ€æ¡†èƒŒæ™¯æ¨¡ç³Š */
        #language-modal, #deepl-modal {
            backdrop-filter: blur(4px);
            transition: backdrop-filter 0.3s;
        }
        
        /* å›¾æ ‡æŒ‰é’®åŠ¨æ•ˆ */
        .icon-btn {
            transition: all 0.2s;
        }
        .icon-btn:hover {
            background-color: #F1F5F9;
            color: #0F172A;
            transform: scale(1.05);
        }
        /* ç›®æ ‡è¯­è¨€é…è‰²ï¼ˆæ·¡æ£•è‰²ï¼‰ */
        .text-target-brown { color: #726e69; }
        .bg-target-brown { background-color: #f9f7f3; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-slate-50/80 backdrop-blur-xl border-b border-slate-200/50 sticky top-0 z-40 transition-all duration-300 shadow-sm">
        <div class="container mx-auto px-6 h-16 flex justify-between items-center">
            <h1 class="logo text-xl text-slate-700 flex items-center space-x-2.5">
                <img src="favicon_square.png" alt="Logo" class="h-8 w-8 opacity-90 drop-shadow-sm rounded-md">
                <span><span class="bg-slate-00 text-slate-700 px-1 py-0.5 rounded-lg shadow-sm text-m align-middle mr-0">Multi</span><span class=" px-0.5 py-0.5 text-m align-middle mr-0">Translator</span>
            </h1>
            <div class="flex items-center gap-3">
                <button id="import-deepl-btn" class="btn px-4 py-2 border border-slate-200 rounded-xl text-sm font-medium text-slate-600 bg-white hover:text-slate-900 hover:border-slate-300 hover:bg-slate-50 shadow-sm hover:shadow">
                    å¯¼å…¥ DeepL API Key
                </button>
                <button id="add-window-btn" class="btn bg-slate-100 hover:bg-slate-200 text-slate-700 border border-slate-200 px-4 py-2 rounded-xl text-sm font-medium shadow-sm hover:shadow-md flex items-center gap-2">
                    + æ·»åŠ 
                </button>
				<select id="ui-lang-select" class="language-selector px-4 py-2 border border-slate-200 rounded-xl text-sm font-medium text-slate-600 bg-white hover:border-slate-300 shadow-sm">
					<option value="zh">ä¸­æ–‡</option>
					<option value="en">English</option>
				</select>
            </div>
        </div>
    </header>

    <main class="container mx-auto py-10 px-6 flex-grow">
        <div id="translation-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            </div>
    </main>

    <div id="language-modal" class="fixed inset-0 bg-slate-900/20 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border border-white/50 transform transition-all scale-100">
            <h3 class="text-xl font-bold text-slate-800 mb-8 flex items-center gap-2">
                <i class="fa-solid fa-plus-circle text-slate-400"></i> æ·»åŠ ç¿»è¯‘çª—å£
            </h3>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-slate-500 mb-2.5 uppercase tracking-wide text-xs">æºè¯­è¨€</label>
                    <div class="relative">
                        <select id="source-language" class="language-selector w-full border border-slate-200 rounded-xl px-4 py-3 text-slate-700 bg-slate-50 hover:bg-white focus:bg-white focus:border-slate-400 focus:ring-4 focus:ring-slate-100 transition-all">
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="en">è‹±æ–‡</option>
                            <option value="ja">æ—¥æ–‡</option>
                            <option value="ko">éŸ©æ–‡</option>
                            <option value="fr">æ³•æ–‡</option>
                            <option value="de">å¾·æ–‡</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-center -my-2 relative z-10">
                     <div class="bg-slate-100 p-1.5 rounded-full text-slate-400 border border-white shadow-sm">
                         <i class="fa-solid fa-arrow-down"></i>
                     </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-500 mb-2.5 uppercase tracking-wide text-xs">ç›®æ ‡è¯­è¨€</label>
                    <div class="relative">
                        <select id="target-language" class="language-selector w-full border border-slate-200 rounded-xl px-4 py-3 text-slate-700 bg-slate-50 hover:bg-white focus:bg-white focus:border-slate-400 focus:ring-4 focus:ring-slate-100 transition-all">
                            <option value="en">è‹±æ–‡</option>
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="ja">æ—¥æ–‡</option>
                            <option value="ko">éŸ©æ–‡</option>
                            <option value="fr">æ³•æ–‡</option>
                            <option value="de">å¾·æ–‡</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="mt-10 flex justify-end space-x-3">
                <button id="cancel-modal-btn" class="px-5 py-2.5 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 hover:bg-slate-50 transition-colors">å–æ¶ˆ</button>
                <button id="confirm-add-btn" class="btn bg-slate-800 text-white px-6 py-2.5 rounded-xl text-sm font-semibold hover:bg-slate-900 shadow-lg shadow-slate-300 hover:shadow-xl hover:shadow-slate-300/60 hover:-translate-y-0.5 transition-all">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <div id="deepl-modal" class="fixed inset-0 bg-slate-900/20 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border border-white/50">
            <h3 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                <i class="fa-solid fa-key text-slate-400"></i> å¯¼å…¥ DeepL API Key
            </h3>
            <div class="space-y-5">
                <div>
                    <label for="deepl-key-input" class="block text-sm font-semibold text-slate-500 mb-2">API Key</label>
                    <input id="deepl-key-input" type="password" class="w-full border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:outline-none focus:border-slate-400 focus:ring-4 focus:ring-slate-100 bg-slate-50 focus:bg-white transition-all shadow-sm" placeholder="è¯·è¾“å…¥ DeepL API Key">
                </div>
                <div>
                    <label for="deepl-plan-select" class="block text-sm font-semibold text-slate-500 mb-2">è®¡åˆ’ / Plan</label>
                    <div class="relative">
                        <select id="deepl-plan-select" class="language-selector w-full border border-slate-200 rounded-xl px-4 py-3 text-slate-700 bg-slate-50 focus:bg-white focus:border-slate-400 focus:ring-4 focus:ring-slate-100 transition-all">
                            <option value="auto">è‡ªåŠ¨åˆ¤æ–­ï¼ˆæ¨èï¼‰</option>
                            <option value="free">Freeï¼ˆapi-free.deepl.comï¼‰</option>
                            <option value="pro">Proï¼ˆapi.deepl.comï¼‰</option>
                        </select>
                    </div>
                </div>
                <div class="text-xs text-slate-500 leading-relaxed bg-blue-50/50 p-4 rounded-xl border border-blue-100/50">
                    <p id="deepl-tip-en">
                        You can find and manage your API keys in the â€œAPI Keys &amp; Limitsâ€ (<a href="https://www.deepl.com/your-account/keys" target="_blank" class="text-blue-600 underline hover:no-underline decoration-blue-300">https://www.deepl.com/your-account/keys</a>) tab when signed into your DeepL API account.
                    </p>
                    <p id="deepl-tip-zh">
                        ç™»å½• DeepL API å¸æˆ·åï¼Œæ‚¨å¯ä»¥åœ¨â€œAPI å¯†é’¥å’Œé™åˆ¶â€ï¼ˆ<a href="https://www.deepl.com/your-account/keys" target="_blank" class="text-blue-600 underline hover:no-underline decoration-blue-300">https://www.deepl.com/your-account/keys</a>ï¼‰é€‰é¡¹å¡ä¸­æŸ¥æ‰¾å’Œç®¡ç†æ‚¨çš„ API å¯†é’¥ã€‚
                    </p>
                </div>
                <div id="deepl-key-status" class="text-xs font-semibold text-slate-500 flex items-center gap-2">
                    </div>
            </div>
            <div class="mt-8 flex justify-end space-x-3">
                <button id="deepl-cancel-btn" class="px-5 py-2.5 rounded-xl text-sm font-medium text-slate-500 hover:bg-slate-50 hover:text-slate-700 transition-colors">å–æ¶ˆ</button>
                <button id="deepl-delete-btn" class="px-5 py-2.5 rounded-xl text-sm font-medium text-red-500 hover:bg-red-50 transition-colors">åˆ é™¤</button>
                <button id="deepl-save-btn" class="btn bg-slate-800 text-white px-6 py-2.5 rounded-xl text-sm font-semibold hover:bg-slate-900 shadow-lg shadow-slate-300 hover:shadow-xl hover:shadow-slate-300/60 hover:-translate-y-0.5 transition-all">ä¿å­˜</button>
            </div>
        </div>
    </div>

	<footer class="bg-white/50 backdrop-blur-sm border-t border-slate-200 py-8 text-center text-sm text-slate-500 mt-auto">
	    <p id="footer-api" class="mb-2 text-slate-600 font-medium">
            ä½¿ç”¨å¼€æºç¿»è¯‘ APIï¼ˆLibreTranslateï¼‰å®ç° 
        </p>
	    <p id="footer-made-by" class="text-xs text-slate-400">
            ç”± 
            <a href="https://github.com/Ahhhh2016" class="text-slate-500 hover:text-slate-800 hover:underline font-medium transition-colors">Ahhhh2016</a> åˆ¶ä½œï¼Œ
            å¸Œæœ›è¿™ä¸ªå°å·¥å…·å¯¹ä½ æœ‰å¸®åŠ©
        </p>
        <p id="busuanzi_container_site_pv" class="text-xs text-slate-400 mt-2 opacity-80">
            ğŸ‘€ å·²æœ‰ <span id="busuanzi_value_site_pv" class="font-mono font-bold text-slate-500">-</span> ä½æœ‹å‹è®¿é—®äº†è¿™ä¸ªé¡µé¢
        </p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // é»˜è®¤ç¿»è¯‘çª—å£é…ç½®
			const defaultTranslations = [
				{ source: 'zh', target: 'en' },
				{ source: 'en', target: 'zh' }
			];

            // è¯»å–æœ¬åœ°ä¿å­˜çš„ç¿»è¯‘çª—å£ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é…ç½®
            const savedTranslations = JSON.parse(localStorage.getItem('translationWindows') || 'null');
            const initialTranslations = Array.isArray(savedTranslations) && savedTranslations.length
                ? savedTranslations
                : defaultTranslations;

            // å°†å½“å‰çª—å£é…ç½®ä¿å­˜åˆ° localStorage
            function saveCurrentWindows() {
                const configs = Array.from(document.querySelectorAll('.translation-window')).map(card => {
                    const textarea = card.querySelector('textarea.input-box');
                    const parentEl = card.parentElement;
                    const span = card.dataset.span || '1';
                    let heightPx = 0;
                    if (textarea) {
                        const h = parseFloat(getComputedStyle(textarea).height);
                        if (!Number.isNaN(h)) heightPx = Math.max(0, Math.round(h));
                    }
                    const columnAttr = parentEl && parentEl.getAttribute && parentEl.getAttribute('data-column');
                    const column = columnAttr ? Number(columnAttr) || 0 : 0;
                    return {
                        source: card.dataset.source,
                        target: card.dataset.target,
                        sourceName: card.dataset.sourceName,
                        targetName: card.dataset.targetName,
                        span,
                        height: heightPx,
                        column,
                    };
                });
                localStorage.setItem('translationWindows', JSON.stringify(configs));
            }

            const translationContainer = document.getElementById('translation-container');
            const addWindowBtn = document.getElementById('add-window-btn');
            const languageModal = document.getElementById('language-modal');
            const cancelModalBtn = document.getElementById('cancel-modal-btn');
            const confirmAddBtn = document.getElementById('confirm-add-btn');
            // DeepL å¯¼å…¥ç›¸å…³å…ƒç´ 
            const importDeeplBtn = document.getElementById('import-deepl-btn');
            const deeplModal = document.getElementById('deepl-modal');
            const deeplKeyInput = document.getElementById('deepl-key-input');
            const deeplPlanSelect = document.getElementById('deepl-plan-select');
            const deeplSaveBtn = document.getElementById('deepl-save-btn');
            const deeplCancelBtn = document.getElementById('deepl-cancel-btn');
            const deeplDeleteBtn = document.getElementById('deepl-delete-btn');
            const deeplTipEn = document.getElementById('deepl-tip-en');
            const deeplTipZh = document.getElementById('deepl-tip-zh');
            const deeplKeyStatus = document.getElementById('deepl-key-status');
            const sourceLanguageSelect = document.getElementById('source-language');
            const targetLanguageSelect = document.getElementById('target-language');
			const lgQuery = window.matchMedia('(min-width: 1024px)'); // å¯¹åº” Tailwind çš„ lg æ–­ç‚¹
			
            // ===== UI å¤šè¯­è¨€ï¼ˆi18nï¼‰æ”¯æŒ (ä¿æŒåŸæœ‰é€»è¾‘) =====
			const UI_LANGS = ['zh', 'en'];
			function detectDefaultUiLang() {
				const saved = (localStorage.getItem('ui_lang') || '').toLowerCase();
				if (UI_LANGS.includes(saved)) return saved;
				const nav = (navigator.language || '').toLowerCase();
				return nav.startsWith('zh') ? 'zh' : 'en';
			}
			let currentUiLang = detectDefaultUiLang();
			const UI_I18N = {
				zh: {
					importDeepl: 'å¯¼å…¥ DeepL API Key',
					add: '+ æ·»åŠ ',
					addWindowTitle: 'æ·»åŠ ç¿»è¯‘çª—å£',
					sourceLangLabel: 'æºè¯­è¨€',
					targetLangLabel: 'ç›®æ ‡è¯­è¨€',
					cancel: 'å–æ¶ˆ',
					confirm: 'ç¡®è®¤æ·»åŠ ',
					deeplModalTitle: 'å¯¼å…¥ DeepL API Key',
					apiKeyLabel: 'API Key',
					planLabel: 'è®¡åˆ’ / Plan',
					planAuto: 'è‡ªåŠ¨åˆ¤æ–­ï¼ˆæ¨èï¼‰',
					planFree: 'Freeï¼ˆapi-free.deepl.comï¼‰',
					planPro: 'Proï¼ˆapi.deepl.comï¼‰',
					deeplKeyPlaceholder: 'è¯·è¾“å…¥ DeepL API Key',
					deeplKeyStatusHas: 'âœ… å½“å‰çŠ¶æ€ï¼šå·²è®¾ç½® API Key',
					deeplKeyStatusNone: 'âšª å½“å‰çŠ¶æ€ï¼šæœªè®¾ç½® API Key',
					deeplKeyCleared: 'å·²æ¸…é™¤ DeepL API Key',
					deeplKeyUpdated: 'DeepL API Key å·²æ›´æ–°ï¼ˆè¦†ç›–ï¼‰',
					deeplKeySaved: 'DeepL API Key å·²ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨ï¼ˆä»…æ­¤è®¾å¤‡ï¼‰',
					deeplDeleteConfirm: 'ç¡®å®šè¦åˆ é™¤å·²ä¿å­˜çš„ DeepL API Key å—ï¼Ÿæ­¤æ“ä½œä»…å½±å“æœ¬æµè§ˆå™¨ã€‚',
					deeplNoKey: 'å½“å‰æœªè®¾ç½® DeepL API Key',
					delete: 'åˆ é™¤',
					save: 'ä¿å­˜',
					speak: 'æœ—è¯»',
					copy: 'å¤åˆ¶',
					resize: 'æ‹–åŠ¨è°ƒæ•´å¤§å°',
					translating: 'ç¿»è¯‘ä¸­â€¦',
					translateFailed: 'ç¿»è¯‘å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
					ttsUnsupported: 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæœ—è¯»åŠŸèƒ½',
					sameLangError: 'æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ä¸èƒ½ç›¸åŒ',
					duplicateCardError: 'å·²å­˜åœ¨ç›¸åŒçš„ç¿»è¯‘å¡ç‰‡ï¼ˆç›¸åŒæºè¯­è¨€ä¸ç›®æ ‡è¯­è¨€ï¼‰',
					footerMadeBy_html: 'ç”± <a href="https://github.com/Ahhhh2016" class="text-slate-500 hover:text-slate-800 hover:underline font-medium transition-colors">Ahhhh2016</a> åˆ¶ä½œï¼Œ å¸Œæœ›è¿™ä¸ªå°å·¥å…·å¯¹ä½ æœ‰å¸®åŠ©',
					footerApi: 'ä½¿ç”¨å¼€æºç¿»è¯‘ APIï¼ˆLibreTranslateï¼‰å®ç°',
					footerPV_html: 'ğŸ‘€ å·²æœ‰ <span id="busuanzi_value_site_pv" class="font-mono font-bold text-slate-500">-</span> ä½æœ‹å‹è®¿é—®äº†è¿™ä¸ªé¡µé¢',
					deeplFooter_using: 'æ­£åœ¨ä½¿ç”¨DeepL APIè¿›è¡Œç¿»è¯‘',
					deeplFooter_fallback: 'æœªæ·»åŠ DeepL APIï¼Œä½¿ç”¨LibreTranslate APIè¿›è¡Œç¿»è¯‘',
					langName_zh: 'ä¸­æ–‡',
					langName_en: 'è‹±æ–‡',
					langName_ja: 'æ—¥æ–‡',
					langName_ko: 'éŸ©æ–‡',
					langName_fr: 'æ³•æ–‡',
					langName_de: 'å¾·æ–‡',
					inputPlaceholder: 'è¾“å…¥{sourceName}æ–‡æœ¬...'
				},
				en: {
					importDeepl: 'Import DeepL API Key',
					add: '+ Add',
					addWindowTitle: 'Add Translation Window',
					sourceLangLabel: 'Source language',
					targetLangLabel: 'Target language',
					cancel: 'Cancel',
					confirm: 'Confirm',
					deeplModalTitle: 'Import DeepL API Key',
					apiKeyLabel: 'API Key',
					planLabel: 'Plan',
					planAuto: 'Auto detect (recommended)',
					planFree: 'Free (api-free.deepl.com)',
					planPro: 'Pro (api.deepl.com)',
					deeplKeyPlaceholder: 'Enter DeepL API Key',
					deeplKeyStatusHas: 'âœ… Status: API Key set',
					deeplKeyStatusNone: 'âšª Status: No API Key',
					deeplKeyCleared: 'DeepL API Key cleared',
					deeplKeyUpdated: 'DeepL API Key updated (overwritten)',
					deeplKeySaved: 'DeepL API Key saved in this browser (this device only)',
					deeplDeleteConfirm: 'Delete the saved DeepL API Key? This only affects this browser.',
					deeplNoKey: 'No DeepL API Key set',
					delete: 'Delete',
					save: 'Save',
					speak: 'Speak',
					copy: 'Copy',
					resize: 'Drag to resize',
					translating: 'Translatingâ€¦',
					translateFailed: 'Translation failed, please try again later',
					ttsUnsupported: 'Text-to-speech is not supported in this browser',
					sameLangError: 'Source and target languages cannot be the same',
					duplicateCardError: 'A translation card with the same source and target already exists',
					footerMadeBy_html: 'Made by <a href="https://github.com/Ahhhh2016" class="text-slate-500 hover:text-slate-800 hover:underline font-medium transition-colors">Ahhhh2016</a>, hope this little tool can help you',
					footerApi: 'Powered by the open-source LibreTranslate API',
					footerPV_html: 'ğŸ‘€ <span id="busuanzi_value_site_pv" class="font-mono font-bold text-slate-500">-</span> visits to this page',
					deeplFooter_using: 'Using DeepL API for translation',
					deeplFooter_fallback: 'DeepL API not set, using LibreTranslate API for translation',
					langName_zh: 'Chinese',
					langName_en: 'English',
					langName_ja: 'Japanese',
					langName_ko: 'Korean',
					langName_fr: 'French',
					langName_de: 'German',
					inputPlaceholder: 'Enter {sourceName} text...'
				}
			};
			function t(key, vars) {
				const dict = UI_I18N[currentUiLang] || {};
				let s = dict[key] || key;
				if (vars && typeof s === 'string') {
					s = s.replace(/\{(\w+)\}/g, (_, k) => (vars[k] != null ? String(vars[k]) : ''));
				}
				return s;
			}
			function getLanguageDisplayName(code) {
				const key = 'langName_' + (code || '');
				return (UI_I18N[currentUiLang] && UI_I18N[currentUiLang][key]) || code;
			}
			function updateLangOptionsText() {
				if (sourceLanguageSelect && sourceLanguageSelect.options) {
					for (const opt of sourceLanguageSelect.options) {
						opt.textContent = getLanguageDisplayName(opt.value);
					}
				}
				if (targetLanguageSelect && targetLanguageSelect.options) {
					for (const opt of targetLanguageSelect.options) {
						opt.textContent = getLanguageDisplayName(opt.value);
					}
				}
			}
			function applyDeeplTipsLang() {
				if (deeplTipZh && deeplTipEn) {
					const isZh = currentUiLang === 'zh';
					deeplTipZh.style.display = isZh ? '' : 'none';
					deeplTipEn.style.display = isZh ? 'none' : '';
				}
			}
			// æ ¹æ® DeepL å¯ç”¨æ€§æ›´æ–°é¡µè„šçŠ¶æ€
			function updateFooterApiStatus(preferred) {
				const el = document.getElementById('footer-api');
				if (!el) return;
				if (preferred === 'deepl') {
					el.textContent = t('deeplFooter_using');
					return;
				}
				if (preferred === 'libre') {
					el.textContent = t('deeplFooter_fallback');
					return;
				}
				const deeplAvailable = !!getDeepLKey() || (backendReachable && (getDeepLKey() || backendHasServerKey));
				el.textContent = deeplAvailable ? t('deeplFooter_using') : t('deeplFooter_fallback');
			}
			function applyI18nToStatic() {
				document.documentElement.lang = currentUiLang === 'zh' ? 'zh-CN' : 'en';
				const importBtn = document.getElementById('import-deepl-btn');
				const addBtn = document.getElementById('add-window-btn');
				if (importBtn) importBtn.textContent = t('importDeepl');
				if (addBtn) {
                    addBtn.innerHTML = `${t('add')}`;
                }
				
                const langModalTitle = document.querySelector('#language-modal h3');
                const srcLabel = sourceLanguageSelect ? sourceLanguageSelect.parentElement.previousElementSibling : null;
                const tgtLabel = targetLanguageSelect ? targetLanguageSelect.parentElement.previousElementSibling : null;
				if (langModalTitle) langModalTitle.innerHTML = `<i class="fa-solid fa-plus-circle text-slate-400"></i> ${t('addWindowTitle')}`;
                if (srcLabel && srcLabel.tagName === 'LABEL') srcLabel.textContent = t('sourceLangLabel');
                if (tgtLabel && tgtLabel.tagName === 'LABEL') tgtLabel.textContent = t('targetLangLabel');
                
				const cancelBtn = document.getElementById('cancel-modal-btn');
				const confirmBtn = document.getElementById('confirm-add-btn');
				if (cancelBtn) cancelBtn.textContent = t('cancel');
				if (confirmBtn) confirmBtn.textContent = t('confirm');
				updateLangOptionsText();
				
				const deeplTitle = document.querySelector('#deepl-modal h3');
				if (deeplTitle) deeplTitle.innerHTML = `<i class="fa-solid fa-key text-slate-400"></i> ${t('deeplModalTitle')}`;
				const keyLabel = document.querySelector('label[for="deepl-key-input"]');
				const planLabel = document.querySelector('label[for="deepl-plan-select"]');
				if (keyLabel) keyLabel.textContent = t('apiKeyLabel');
				if (planLabel) planLabel.textContent = t('planLabel');
                if (deeplKeyInput) deeplKeyInput.placeholder = t('deeplKeyPlaceholder');
				if (deeplPlanSelect && deeplPlanSelect.options && deeplPlanSelect.options.length >= 3) {
					deeplPlanSelect.options[0].textContent = t('planAuto');
					deeplPlanSelect.options[1].textContent = t('planFree');
					deeplPlanSelect.options[2].textContent = t('planPro');
				}
				const dCancel = document.getElementById('deepl-cancel-btn');
				const dDelete = document.getElementById('deepl-delete-btn');
				const dSave = document.getElementById('deepl-save-btn');
				if (dCancel) dCancel.textContent = t('cancel');
				if (dDelete) dDelete.textContent = t('delete');
				if (dSave) dSave.textContent = t('save');
				
				const footerMadeBy = document.getElementById('footer-made-by');
				const footerApi = document.getElementById('footer-api');
				const footerPv = document.getElementById('busuanzi_container_site_pv');
				if (footerMadeBy) footerMadeBy.innerHTML = t('footerMadeBy_html');
				if (footerApi) footerApi.textContent = t('footerApi');
				if (footerPv) footerPv.innerHTML = t('footerPV_html');
				applyDeeplTipsLang();
				updateFooterApiStatus();
			}

            // åŒæºéƒ¨ç½²æ—¶æ— éœ€é¢å¤–é…ç½® localStorage
            const BACKEND_URL = (localStorage.getItem('backend_url') || window.location.origin).replace(/\/+$/, '');
            let backendReachable = false;
            let backendHasServerKey = false;
            (async function initBackendHealth() {
                try {
                    const r = await fetch(BACKEND_URL + '/health', { mode: 'cors' });
                    if (r.ok) {
                        const j = await r.json().catch(() => null);
                        backendReachable = true;
                        backendHasServerKey = Boolean(j && j.deeplKeyConfigured);
                    }
                } catch (_) { }
				updateFooterApiStatus();
            })();

            // DeepL Key: è·å–/ä¿å­˜
            function getDeepLKey() { return localStorage.getItem('deepl_api_key') || ''; }
            function setDeepLKey(key) {
                if (!key) localStorage.removeItem('deepl_api_key');
                else localStorage.setItem('deepl_api_key', key);
            }
            function getDeepLPlan() { return localStorage.getItem('deepl_api_plan') || 'auto'; }
            function setDeepLPlan(plan) {
                if (!plan) localStorage.removeItem('deepl_api_plan');
                else localStorage.setItem('deepl_api_plan', plan);
            }
            function showDeeplModal() {
                deeplKeyInput.value = '';
				if (deeplKeyInput) deeplKeyInput.placeholder = t('deeplKeyPlaceholder');
                if (deeplPlanSelect) deeplPlanSelect.value = getDeepLPlan();
				if (deeplKeyStatus) {
					const hasKey = !!getDeepLKey();
					deeplKeyStatus.textContent = hasKey ? t('deeplKeyStatusHas') : t('deeplKeyStatusNone');
				}
                if (deeplDeleteBtn) {
                    const hasKey = !!getDeepLKey();
                    deeplDeleteBtn.disabled = !hasKey;
                    if (hasKey) deeplDeleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    else deeplDeleteBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                deeplModal.classList.remove('hidden');
            }
            function hideDeeplModal() { deeplModal.classList.add('hidden'); }
			applyDeeplTipsLang();
            
            if (importDeeplBtn) importDeeplBtn.addEventListener('click', showDeeplModal);
            if (deeplCancelBtn) deeplCancelBtn.addEventListener('click', hideDeeplModal);
            if (deeplSaveBtn) {
                deeplSaveBtn.addEventListener('click', () => {
                    const prev = getDeepLKey();
                    const key = (deeplKeyInput.value || '').trim();
                    const plan = deeplPlanSelect ? deeplPlanSelect.value : 'auto';
                    setDeepLKey(key);
                    setDeepLPlan(plan);
                    let msg = '';
                    if (!key) msg = t('deeplKeyCleared');
                    else if (prev) msg = t('deeplKeyUpdated');
                    else msg = t('deeplKeySaved');
                    alert(msg);
                    hideDeeplModal();
					updateFooterApiStatus();
                });
            }
            if (deeplDeleteBtn) {
                deeplDeleteBtn.addEventListener('click', () => {
                    if (!getDeepLKey()) { alert(t('deeplNoKey')); return; }
                    const ok = confirm(t('deeplDeleteConfirm'));
                    if (!ok) return;
                    setDeepLKey('');
                    alert(t('deeplKeyCleared'));
                    hideDeeplModal();
					updateFooterApiStatus();
                });
            }
            if (deeplModal) {
                deeplModal.addEventListener('click', function(e) {
                    if (e.target === deeplModal) hideDeeplModal();
                });
            }

            // Masonry å¸ƒå±€ (ä¿æŒä¸å˜)
            function getColumnWrappers() {
                const col1 = translationContainer.querySelector('[data-column="1"]');
                const col2 = translationContainer.querySelector('[data-column="2"]');
                return [col1, col2];
            }
            function ensureColumnWrappers() {
                let [col1, col2] = getColumnWrappers();
                if (!col1 || !col2) {
                    const existingCards = Array.from(translationContainer.querySelectorAll(':scope > .translation-window'));
                    translationContainer.innerHTML = '';
                    col1 = document.createElement('div');
                    col1.dataset.column = '1';
                    col1.className = 'flex flex-col gap-6';
                    col2 = document.createElement('div');
                    col2.dataset.column = '2';
                    col2.className = 'flex flex-col gap-6';
                    translationContainer.appendChild(col1);
                    translationContainer.appendChild(col2);
                    existingCards.forEach(card => {
                        if ((card.dataset.span || '1') === '2') {
                            translationContainer.appendChild(card);
                            card.style.gridColumn = '1 / -1';
                        } else {
                            const h1 = measureColumnHeight(col1);
                            const h2 = measureColumnHeight(col2);
                            const targetCol = h1 <= h2 ? col1 : col2;
                            targetCol.appendChild(card);
                        }
                    });
                }
            }
            function teardownColumnWrappers() {
                const [col1, col2] = getColumnWrappers();
                if (!col1 || !col2) return;
                const allCards = [...col1.children, ...col2.children];
                translationContainer.innerHTML = '';
                allCards.forEach(card => translationContainer.appendChild(card));
            }
            function measureColumnHeight(columnEl) {
                let total = 0;
                Array.from(columnEl.children).forEach(child => {
                    total += child.getBoundingClientRect().height;
                });
                return total;
            }
            function appendCardResponsive(card) {
                if (lgQuery.matches) {
                    ensureColumnWrappers();
                    const [col1, col2] = getColumnWrappers();
                    if ((card.dataset.span || '1') === '2') {
                        translationContainer.appendChild(card);
                        card.style.gridColumn = '1 / -1';
                    } else {
                        const h1 = measureColumnHeight(col1);
                        const h2 = measureColumnHeight(col2);
                        const targetCol = h1 <= h2 ? col1 : col2;
                        targetCol.appendChild(card);
                    }
                } else {
                    translationContainer.appendChild(card);
                }
            }
            function moveCardToFullWidth(card) {
                if (!lgQuery.matches) return;
                ensureColumnWrappers();
                card.dataset.span = '2';
                translationContainer.appendChild(card);
                card.style.gridColumn = '1 / -1';
            }
            function moveCardToColumns(card) {
                if (!lgQuery.matches) return;
                ensureColumnWrappers();
                card.dataset.span = '1';
                card.style.gridColumn = '';
                const [col1, col2] = getColumnWrappers();
                const h1 = measureColumnHeight(col1);
                const h2 = measureColumnHeight(col2);
                const targetCol = h1 <= h2 ? col1 : col2;
                targetCol.appendChild(card);
            }
            function applyResponsiveLayout() {
                if (lgQuery.matches) ensureColumnWrappers();
                else teardownColumnWrappers();
            }
            if (lgQuery.addEventListener) lgQuery.addEventListener('change', applyResponsiveLayout);
            else if (lgQuery.addListener) lgQuery.addListener(applyResponsiveLayout);

            // API äº¤äº’é€»è¾‘ (DeepL & LibreTranslate)
            function mapAppLangToDeepL(appLang) {
                const map = { zh: 'ZH', en: 'EN', ja: 'JA', ko: 'KO', fr: 'FR', de: 'DE' };
                return map[appLang] || (appLang ? appLang.toUpperCase() : '');
            }
            async function translateViaBackend(text, sourceLang, targetLang) {
                const apiKey = getDeepLKey();
                const body = { text, targetLang, sourceLang };
                if (apiKey) body.apiKey = apiKey;
                const resp = await fetch(BACKEND_URL + '/api/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                    mode: 'cors'
                });
                if (!resp.ok) throw new Error('backend error ' + resp.status);
                const data = await resp.json();
                if (!data || data.ok !== true) throw new Error('backend response invalid');
				updateFooterApiStatus('deepl');
                return data.resultText || (data.translations && data.translations[0] && data.translations[0].text) || '';
            }
            async function translateWithDeepL(text, sourceLang, targetLang) {
                const apiKey = getDeepLKey();
                if (!apiKey) throw new Error('No DeepL API key');
                const plan = getDeepLPlan();
                let endpoints = [];
                if (plan === 'free') endpoints = ['https://api-free.deepl.com/v2/translate'];
                else if (plan === 'pro') endpoints = ['https://api.deepl.com/v2/translate'];
                else {
                    const looksFree = apiKey.includes(':fx');
                    endpoints = looksFree
                        ? ['https://api-free.deepl.com/v2/translate', 'https://api.deepl.com/v2/translate']
                        : ['https://api.deepl.com/v2/translate', 'https://api-free.deepl.com/v2/translate'];
                }
                const params = new URLSearchParams();
                params.set('auth_key', apiKey);
                params.set('text', text);
                const tgt = mapAppLangToDeepL(targetLang);
                if (!tgt) throw new Error('Invalid target_lang');
                params.set('target_lang', tgt);
                if (sourceLang) {
                    const src = mapAppLangToDeepL(sourceLang);
                    if (src) params.set('source_lang', src);
                }
                let resp, data, lastErr = null;
                for (const endpoint of endpoints) {
                    try {
                        resp = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
                            body: params.toString(),
                            mode: 'cors',
                        });
                        if (!resp.ok) {
                            lastErr = new Error(`DeepL error ${resp.status}`);
                            continue;
                        }
                        data = await resp.json();
                        break;
                    } catch (e) { lastErr = e; continue; }
                }
                if (!data) throw lastErr || new Error('DeepL request failed');
				updateFooterApiStatus('deepl');
                return data?.translations?.[0]?.text ?? '';
            }
            async function translateText(text, sourceLang, targetLang) {
                if (!text.trim()) return '';
                try {
                    if (backendReachable && (getDeepLKey() || backendHasServerKey)) {
                        return await translateViaBackend(text, sourceLang, targetLang);
                    }
                } catch (e) {}
                const deeplKey = getDeepLKey();
                if (deeplKey) {
                    try { return await translateWithDeepL(text, sourceLang, targetLang); }
                    catch (e) {}
                }
                try {
                    const endpoints = ['https://translate.terraprint.co/translate', 'https://translate.fedilab.app/translate'];
                    let resp, usedLT = '';
                    for (const API of endpoints) {
                        try {
                            resp = await fetch(API, {
                                method: 'POST', mode: 'cors',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ q: text, source: sourceLang, target: targetLang, format: 'text' })
                            });
                            if (resp.ok) { usedLT = API; break; }
                        } catch (_) {}
                    }
                    if (!resp || !resp.ok) throw new Error('all endpoints failed');
                    const data = await resp.json();
					updateFooterApiStatus('libre');
                    return data.translatedText;
                } catch (err) {
					return t('translateFailed');
                }
            }

            // Web Speech API
            const isSpeechSupported = typeof window !== 'undefined' && 'speechSynthesis' in window;
            let cachedVoices = [];
            function refreshVoices() { try { cachedVoices = window.speechSynthesis.getVoices() || []; } catch (_) { cachedVoices = []; } }
            if (isSpeechSupported) {
                refreshVoices();
                if (window.speechSynthesis.addEventListener) window.speechSynthesis.addEventListener('voiceschanged', refreshVoices);
                else window.speechSynthesis.onvoiceschanged = refreshVoices;
            }
            function mapAppLangToBCP47(appLang) {
                const map = { zh: 'zh-CN', en: 'en-US', ja: 'ja-JP', ko: 'ko-KR', fr: 'fr-FR', de: 'de-DE' };
                return map[appLang] || (appLang || 'en');
            }
            function pickVoiceForLang(appLang) {
                if (!isSpeechSupported) return null;
                const targetTag = mapAppLangToBCP47(appLang).toLowerCase();
                if (!cachedVoices || !cachedVoices.length) refreshVoices();
                const matches = (cachedVoices || []).filter(v => {
                    const lang = (v.lang || '').toLowerCase();
                    return lang === targetTag || lang.startsWith(targetTag.split('-')[0] + '-');
                });
                if (!matches.length) return null;
                const google = matches.find(v => /google/i.test(v.name));
                if (google) return google;
                const ms = matches.find(v => /microsoft/i.test(v.name));
                if (ms) return ms;
                return matches[0];
            }
            const speakingState = { utterance: null, button: null };
            function setSpeakingVisual(button, speaking) {
                if (!button) return;
                const icon = button.querySelector('i');
                if (!icon) return;
                if (speaking) {
                    icon.classList.remove('fa-volume-high');
                    icon.classList.add('fa-stop');
                    button.classList.add('text-target-brown', 'bg-target-brown');
                } else {
                    icon.classList.remove('fa-stop');
                    icon.classList.add('fa-volume-high');
                    button.classList.remove('text-target-brown', 'bg-target-brown');
                }
            }
            function stopSpeaking() {
                if (isSpeechSupported) { try { window.speechSynthesis.cancel(); } catch (_) {} }
                if (speakingState.button) setSpeakingVisual(speakingState.button, false);
                speakingState.utterance = null;
                speakingState.button = null;
            }
            function speakText(text, appLang, button) {
                if (!isSpeechSupported) { alert(t('ttsUnsupported')); return; }
                const content = (text || '').toString().trim();
                if (!content) return;
                if (window.speechSynthesis.speaking) {
                    const wasSameButton = speakingState.button === button;
                    stopSpeaking();
                    if (wasSameButton) return;
                }
                const utter = new SpeechSynthesisUtterance(content);
                utter.lang = mapAppLangToBCP47(appLang);
                const v = pickVoiceForLang(appLang);
                if (v) utter.voice = v;
                utter.onstart = () => setSpeakingVisual(button, true);
                utter.onend = () => { if (speakingState.button === button) setSpeakingVisual(button, false); };
                utter.onerror = () => { if (speakingState.button === button) setSpeakingVisual(button, false); };
                speakingState.utterance = utter;
                speakingState.button = button;
                try { window.speechSynthesis.speak(utter); } catch (e) { setSpeakingVisual(button, false); }
            }

            // æ‹–æ‹½æ’åºé€»è¾‘ (ä¿æŒä¸å˜)
            function setupDragReorder(card) {
                const header = card.querySelector('.card-title');
                if (!header) return;
                let isDragging = false, placeholder = null, startOffsetX = 0, startOffsetY = 0, originParent = null, lastParent = null;
                
                function candidateSiblings(parentEl) {
                    return Array.from(parentEl.children).filter(el => el !== card && el !== placeholder && el.classList && el.classList.contains('translation-window'));
                }
                function findBeforeEl(parentEl, clientY) {
                    const siblings = candidateSiblings(parentEl);
                    for (const el of siblings) {
                        const r = el.getBoundingClientRect();
                        if (clientY < r.top + r.height / 2) return el;
                    }
                    return null;
                }
                function findBeforeFullWidth(clientY) {
                    const [col1, col2] = getColumnWrappers();
                    const r1 = col1?.getBoundingClientRect(), r2 = col2?.getBoundingClientRect();
                    const topBoundary = Math.min(r1 ? r1.top : Infinity, r2 ? r2.top : Infinity);
                    if (clientY < topBoundary && (col1 || col2)) return col1 || col2 || translationContainer.firstChild;
                    const fullCards = Array.from(translationContainer.querySelectorAll(':scope > .translation-window[data-span="2"]')).filter(el => el !== card && el !== placeholder);
                    for (const el of fullCards) {
                        const r = el.getBoundingClientRect();
                        if (clientY < r.top + r.height / 2) return el;
                    }
                    return null;
                }
                function onPointerMove(e) {
                    if (!isDragging) return;
                    card.style.left = (e.clientX - startOffsetX) + 'px';
                    card.style.top = (e.clientY - startOffsetY) + 'px';
                    let targetParent = lastParent || originParent, zone = 'single';
                    if (lgQuery.matches) {
                        ensureColumnWrappers();
                        const [col1, col2] = getColumnWrappers();
                        const r1 = col1?.getBoundingClientRect(), r2 = col2?.getBoundingClientRect();
                        if (r1 && e.clientX >= r1.left && e.clientX <= r1.right) { targetParent = col1; zone = 'column'; }
                        else if (r2 && e.clientX >= r2.left && e.clientX <= r2.right) { targetParent = col2; zone = 'column'; }
                        else { targetParent = translationContainer; zone = 'full'; }
                    }
                    if (targetParent !== placeholder.parentElement) targetParent.appendChild(placeholder);
                    lastParent = targetParent;
                    if (zone === 'full' && lgQuery.matches) placeholder.style.gridColumn = '1 / -1';
                    else placeholder.style.gridColumn = '';
                    
                    if (zone === 'full' && lgQuery.matches) {
                        const beforeFW = findBeforeFullWidth(e.clientY);
                        if (beforeFW) translationContainer.insertBefore(placeholder, beforeFW);
                        else translationContainer.appendChild(placeholder);
                    } else {
                        const beforeEl = findBeforeEl(targetParent, e.clientY);
                        if (beforeEl) targetParent.insertBefore(placeholder, beforeEl);
                        else targetParent.appendChild(placeholder);
                    }
                }
                function onPointerUp() {
                    if (!isDragging) return;
                    if (placeholder && placeholder.parentElement) {
                        const parent = placeholder.parentElement;
                        const dropInFullZone = lgQuery.matches && parent === translationContainer;
                        if (dropInFullZone) { card.dataset.span = '2'; card.style.gridColumn = '1 / -1'; }
                        else if (lgQuery.matches) { card.dataset.span = '1'; card.style.gridColumn = ''; }
                        parent.insertBefore(card, placeholder);
                        parent.removeChild(placeholder);
                    }
                    placeholder = null; isDragging = false;
                    document.removeEventListener('pointermove', onPointerMove);
                    document.removeEventListener('pointerup', onPointerUp);
                    document.removeEventListener('pointercancel', onPointerUp);
                    document.body.style.userSelect = '';
                    card.classList.remove('dragging');
                    card.style.position = ''; card.style.zIndex = ''; card.style.width = ''; card.style.left = ''; card.style.top = '';
                    saveCurrentWindows();
                }
                header.addEventListener('pointerdown', (e) => {
                    if (e.button !== 0) return;
                    e.preventDefault();
                    if (lgQuery.matches) ensureColumnWrappers();
                    const rect = card.getBoundingClientRect();
                    startOffsetX = e.clientX - rect.left;
                    startOffsetY = e.clientY - rect.top;
                    placeholder = document.createElement('div');
                    placeholder.className = 'drop-placeholder';
                    placeholder.style.height = rect.height + 'px';
                    originParent = card.parentElement; lastParent = originParent;
                    originParent.insertBefore(placeholder, card.nextSibling);
                    card.classList.add('dragging');
                    card.style.position = 'fixed'; card.style.zIndex = '9999';
                    card.style.width = rect.width + 'px'; card.style.left = rect.left + 'px'; card.style.top = rect.top + 'px';
                    isDragging = true;
                    document.body.style.userSelect = 'none';
                    document.addEventListener('pointermove', onPointerMove);
                    document.addEventListener('pointerup', onPointerUp);
                    document.addEventListener('pointercancel', onPointerUp);
                });
            }

            // åˆ›å»ºç¿»è¯‘çª—å£
			function createTranslationWindow(source, target, restoredCfg) {
                const windowId = `window-${Date.now()}`;
                const card = document.createElement('div');
                // ä¼˜åŒ–åçš„å¡ç‰‡ç±»å - rounded-2xl
                card.className = 'translation-window rounded-2xl overflow-hidden fade-in relative';
                card.id = windowId;
                card.dataset.source = source;
                card.dataset.target = target;
				const sourceName = getLanguageDisplayName(source);
				const targetName = getLanguageDisplayName(target);
				card.dataset.sourceName = sourceName;
				card.dataset.targetName = targetName;
                card.dataset.span = restoredCfg && restoredCfg.span ? String(restoredCfg.span) : '1';
                
                // ä¼˜åŒ–å†…éƒ¨ HTML ç»“æ„å’Œæ ·å¼ (bg-slate-50, text-slate-800)
                card.innerHTML = `
                    <div class="card-title drag-handle bg-white border-b border-slate-100 py-3.5 px-6 flex justify-between items-center h-14">
                        <div class="text-sm font-bold text-slate-700 flex items-center gap-2">
                            <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs uppercase tracking-wide">${sourceName}</span>
                            <i class="fa-solid fa-arrow-right text-slate-300 text-xs"></i>
                            <span class="bg-target-brown text-target-brown px-2 py-0.5 rounded text-xs uppercase tracking-wide">${targetName}</span>
                        </div>
                        <button class="delete-btn icon-btn w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:text-red-500 hover:bg-red-50 transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-100">
                        <div class="p-0 relative group">
							<textarea class="input-box w-full h-52 p-6 resize-none pr-12 placeholder-slate-400" 
									  placeholder="${t('inputPlaceholder', { sourceName })}" 
                                      data-source="${source}"></textarea>
							<button class="speak-source-btn icon-btn absolute bottom-3 right-3 text-slate-400 p-2 rounded-xl" title="${t('speak')}">
                                <i class="fa-solid fa-volume-high"></i>
                            </button>
                        </div>
                        <div class="p-0 relative bg-slate-50/50">
                            <div class="relative w-full h-52" data-result-wrapper="true">
                                <div class="w-full h-full p-6 overflow-auto pr-12 text-slate-800 leading-relaxed font-medium" data-target="${target}"></div>
								<div class="absolute bottom-3 right-3 flex space-x-1">
                                    <button class="speak-target-btn icon-btn text-slate-400 p-2 rounded-xl" title="${t('speak')}">
                                        <i class="fa-solid fa-volume-high"></i>
                                    </button>
                                    <button class="copy-btn icon-btn text-slate-400 p-2 rounded-xl" title="${t('copy')}">
                                        <i class="fa-regular fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
					<div class="resize-handle" title="${t('resize')}"></div>
                `;
                
                appendCardResponsive(card);
				// æ ¹æ®æ¢å¤é…ç½®æ”¾ç½®åˆ°æŒ‡å®šåŒºåŸŸ/åˆ—
				if (restoredCfg && restoredCfg.span === '2') {
					moveCardToFullWidth(card);
				} else if (restoredCfg && (restoredCfg.column === 1 || restoredCfg.column === 2) && lgQuery.matches) {
					ensureColumnWrappers();
					const [col1, col2] = getColumnWrappers();
					const targetCol = restoredCfg.column === 1 ? col1 : col2;
					if (targetCol) targetCol.appendChild(card);
				}
                saveCurrentWindows();
                
                const textarea = card.querySelector('textarea');
                const resultDiv = card.querySelector('div[data-target]');
                const deleteBtn = card.querySelector('.delete-btn');
                const copyBtn = card.querySelector('.copy-btn');
                const speakSourceBtn = card.querySelector('.speak-source-btn');
                const speakTargetBtn = card.querySelector('.speak-target-btn');
				// æ¢å¤é«˜åº¦
				if (restoredCfg && restoredCfg.height && Number(restoredCfg.height) > 0 && textarea) {
					const h = Math.max(120, Number(restoredCfg.height));
					const resultWrapper = card.querySelector('[data-result-wrapper="true"]');
					textarea.style.height = h + 'px';
					if (resultWrapper) resultWrapper.style.height = h + 'px';
				}
                
                let timeoutId;
                textarea.addEventListener('input', async () => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(async () => {
                        const text = textarea.value;
                        if (isSpeechSupported && window.speechSynthesis.speaking) stopSpeaking();
						resultDiv.textContent = t('translating');
                        // æ­£åœ¨ç¿»è¯‘æ—¶å­—ä½“é¢œè‰²å˜æ·¡
                        resultDiv.classList.add('text-slate-400');
                        const res = await translateText(text, source, target);
                        resultDiv.classList.remove('text-slate-400');
                        resultDiv.textContent = res;
                    }, 500);
                });
                
                copyBtn.addEventListener('click', async () => {
                    const text = resultDiv.textContent.trim();
                    if (!text) return;
                    const icon = copyBtn.querySelector('i');
                    try {
                        await navigator.clipboard.writeText(text);
                        icon.classList.replace('fa-copy', 'fa-check');
                        icon.classList.replace('fa-regular', 'fa-solid');
                        copyBtn.classList.add('text-green-500', 'bg-green-50');
                        setTimeout(() => {
                            icon.classList.replace('fa-check', 'fa-copy');
                            icon.classList.replace('fa-solid', 'fa-regular');
                            copyBtn.classList.remove('text-green-500', 'bg-green-50');
                        }, 1500);
                    } catch (err) {
                        icon.classList.replace('fa-copy', 'fa-xmark');
                        icon.classList.replace('fa-regular', 'fa-solid');
                        setTimeout(() => {
                            icon.classList.replace('fa-xmark', 'fa-copy');
                            icon.classList.replace('fa-solid', 'fa-regular');
                        }, 1500);
                    }
                });
                
                deleteBtn.addEventListener('pointerdown', function(e) { e.stopPropagation(); });
                deleteBtn.addEventListener('click', function() {
                    if (speakingState.button && card.contains(speakingState.button)) stopSpeaking();
                    card.classList.add('fade-out');
                    setTimeout(() => { card.remove(); saveCurrentWindows(); }, 200);
                });

                if (speakSourceBtn) {
                    if (!isSpeechSupported) speakSourceBtn.style.display = 'none';
                    else speakSourceBtn.addEventListener('click', () => { speakText(textarea.value, source, speakSourceBtn); });
                }
                if (speakTargetBtn) {
                    if (!isSpeechSupported) speakTargetBtn.style.display = 'none';
                    else speakTargetBtn.addEventListener('click', () => { speakText(resultDiv.textContent || '', target, speakTargetBtn); });
                }

                // è°ƒæ•´å¤§å°é€»è¾‘ (ä¿æŒä¸å˜)
                const handle = card.querySelector('.resize-handle');
                const resultWrapper = card.querySelector('[data-result-wrapper="true"]');
                let isResizing = false, startX = 0, startY = 0, startHeight = 0; const minHeight = 120;
                function onMouseMove(e) {
                    if (!isResizing) return;
                    const deltaY = e.clientY - startY;
                    const nextHeight = Math.max(minHeight, startHeight + deltaY);
                    textarea.style.height = nextHeight + 'px';
                    resultWrapper.style.height = nextHeight + 'px';
                    if (lgQuery.matches) {
                        const deltaX = e.clientX - startX;
                        const currentSpan = card.dataset.span || '1';
                        if (currentSpan === '1' && deltaX > 60) moveCardToFullWidth(card);
                        else if (currentSpan === '2' && deltaX < -60) {
                            const [col1, col2] = getColumnWrappers();
                            if (col1 && col2) moveCardToColumns(card);
                            else { card.dataset.span = '1'; card.style.gridColumn = ''; }
                        }
                    }
                }
                function onMouseUp() {
                    if (!isResizing) return;
                    isResizing = false;
                    card.classList.remove('resizing');
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
					// ä¿å­˜è°ƒæ•´åçš„å°ºå¯¸ä¸å¸ƒå±€
					saveCurrentWindows();
                }
                if (handle) {
                    handle.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        isResizing = true;
                        startX = e.clientX; startY = e.clientY;
                        startHeight = parseFloat(getComputedStyle(textarea).height) || 160;
                        card.classList.add('resizing');
                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    });
                }
                setupDragReorder(card);
            }
			function refreshAllCardsI18n() {
				const cards = document.querySelectorAll('.translation-window');
				cards.forEach(card => {
					const source = card.dataset.source;
					const target = card.dataset.target;
					const sourceName = getLanguageDisplayName(source);
					const targetName = getLanguageDisplayName(target);
					card.dataset.sourceName = sourceName;
					card.dataset.targetName = targetName;
					
                    // Update header HTML structure
                    const titleDiv = card.querySelector('.card-title .text-sm');
                    if (titleDiv) {
                        titleDiv.innerHTML = `
                            <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs uppercase tracking-wide">${sourceName}</span>
                            <i class="fa-solid fa-arrow-right text-slate-300 text-xs"></i>
                            <span class="bg-target-brown text-target-brown px-2 py-0.5 rounded text-xs uppercase tracking-wide">${targetName}</span>
                        `;
                    }
                    
					const textarea = card.querySelector('textarea.input-box');
					if (textarea) textarea.placeholder = t('inputPlaceholder', { sourceName });
					const speakBtns = card.querySelectorAll('.speak-source-btn, .speak-target-btn');
					speakBtns.forEach(btn => btn.setAttribute('title', t('speak')));
					const copyBtn = card.querySelector('.copy-btn');
					if (copyBtn) copyBtn.setAttribute('title', t('copy'));
					const resize = card.querySelector('.resize-handle');
					if (resize) resize.setAttribute('title', t('resize'));
				});
			}

            initialTranslations.forEach(cfg => { createTranslationWindow(cfg.source, cfg.target, cfg); });

            addWindowBtn.addEventListener('click', function() { languageModal.classList.remove('hidden'); });
            function hideModal() { languageModal.classList.add('hidden'); }
            cancelModalBtn.addEventListener('click', hideModal);
            confirmAddBtn.addEventListener('click', function() {
                const sourceLang = sourceLanguageSelect.value;
                const targetLang = targetLanguageSelect.value;
                if (sourceLang === targetLang) { alert(t('sameLangError')); return; }
                const exists = Array.from(document.querySelectorAll('.translation-window')).some(card =>
                    card.dataset.source === sourceLang && card.dataset.target === targetLang
                );
                if (exists) { alert(t('duplicateCardError')); return; }
				createTranslationWindow(sourceLang, targetLang);
                hideModal();
            });
            languageModal.addEventListener('click', function(e) { if (e.target === languageModal) hideModal(); });

            (function initUiLangSelector() {
                const el = document.getElementById('ui-lang-select');
                if (!el) return;
                el.value = currentUiLang;
                el.addEventListener('change', function() {
                    const v = String(this.value || '').toLowerCase();
                    if (UI_LANGS.includes(v)) {
                        currentUiLang = v;
                        localStorage.setItem('ui_lang', v);
                        applyI18nToStatic();
                        refreshAllCardsI18n();
                        if (deeplKeyStatus) {
                            const hasKey = !!getDeepLKey();
                            deeplKeyStatus.textContent = hasKey ? t('deeplKeyStatusHas') : t('deeplKeyStatusNone');
                        }
                    }
                });
            })();
            applyI18nToStatic();
            if (deeplKeyStatus) {
                const hasKey = !!getDeepLKey();
                deeplKeyStatus.textContent = hasKey ? t('deeplKeyStatusHas') : t('deeplKeyStatusNone');
            }
        });
    </script>
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</body>
</html>